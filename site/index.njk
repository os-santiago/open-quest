---
layout: base.njk
title: Panel Open Quest
tags:
  - dashboard
---
<section class="card">
  <header>
    <div class="badge">Temporada {{ leaderboard.temporada.id }}</div>
    <h2>{{ leaderboard.temporada.titulo }}</h2>
    {% if leaderboard.temporada.descripcion %}
      <p>{{ leaderboard.temporada.descripcion }}</p>
    {% endif %}
    {% if leaderboard.generated_at %}
      <small>Última generación del leaderboard: {{ leaderboard.generated_at }}</small>
    {% elseif leaderboard.missing %}
      <small>No se encontró <code>docs/data/leaderboard.json</code>. Se mostrará un estado base.</small>
    {% elseif leaderboard.parseError %}
      <small>Error al procesar el leaderboard: {{ leaderboard.parseError }}</small>
    {% endif %}
  </header>

  <div class="summary-grid">
    <div class="summary-card">
      <h3>Participantes</h3>
      <p>{{ leaderboard.resumen_global.total_participantes | default(leaderboard.jugadores.length) }}</p>
    </div>
    <div class="summary-card">
      <h3>XP total</h3>
      <p>{{ missionSummary.xpTotalAcumulada }}</p>
    </div>
    <div class="summary-card">
      <h3>Misiones completadas</h3>
      <p>{{ leaderboard.resumen_global.misiones_completadas | default(0) }}</p>
    </div>
    <div class="summary-card">
      <h3>XP promedio</h3>
      <p>{{ leaderboard.resumen_global.xp_promedio | default(0) }}</p>
    </div>
  </div>

  {% if leaderboard.resumen_global.clases_activas.length %}
    <div class="badge">Clases activas</div>
    <ul class="list-inline">
      {% for clase in leaderboard.resumen_global.clases_activas %}
        <li>{{ clase }}</li>
      {% endfor %}
    </ul>
  {% endif %}
</section>

{% if analytics.hasData %}
  <section class="card">
    <h2>Indicadores avanzados</h2>
    <div class="highlight-grid">
      <div class="highlight-card">
        <h3>XP promedio por jugador</h3>
        <strong>{{ analytics.xpPromedioPorJugador | formatDecimal(1) }}</strong>
        <small>Basado en {{ analytics.totalJugadores | formatNumber }} participantes activos.</small>
      </div>
      <div class="highlight-card">
        <h3>XP por misión</h3>
        <strong>{{ analytics.xpPromedioPorMision | formatDecimal(1) }}</strong>
        <small>Relación entre {{ analytics.totalMisiones | formatNumber }} misiones y la XP total.</small>
      </div>
      <div class="highlight-card">
        <h3>Nivel promedio</h3>
        {% if analytics.levelStats.jugadoresConNivel %}
          <strong>{{ analytics.levelStats.promedio | formatDecimal(1) }}</strong>
          <small>Niveles registrados: {{ analytics.levelStats.jugadoresConNivel | formatNumber }}.<br>Máximo {{ analytics.levelStats.maximo | formatNumber }}, mínimo {{ analytics.levelStats.minimo | formatNumber }}.</small>
        {% else %}
          <strong>—</strong>
          <small>Todavía no hay niveles registrados.</small>
        {% endif %}
      </div>
    </div>
  </section>

  <section class="card">
    <h2>Jugadores destacados</h2>
    <div class="grid grid-2">
      <div>
        <h3>Mayor XP acumulada</h3>
        {% if analytics.topXp.length %}
          <ol class="metric-list">
            {% for jugador in analytics.topXp %}
              <li class="metric-item">
                <div class="metric-header">
                  <span class="metric-rank">#{{ loop.index }}</span>
                  <div>
                    <strong>{{ jugador.usuario }}</strong>
                    {% if jugador.nombre %}<br><small>{{ jugador.nombre }}</small>{% endif %}
                  </div>
                  <span class="metric-value">{{ jugador.xp | formatNumber }} XP</span>
                </div>
                <div class="metric-subtext">
                  <span>{{ jugador.clase }}</span>
                  {% if jugador.nivel %}<span>Nivel {{ jugador.nivel | formatNumber }}</span>{% endif %}
                  <span>{{ jugador.misiones | formatNumber }} misiones</span>
                </div>
              </li>
            {% endfor %}
          </ol>
        {% else %}
          <div class="empty-state">Todavía no hay XP registrada en el leaderboard.</div>
        {% endif %}
      </div>
      <div>
        <h3>Más misiones completadas</h3>
        {% if analytics.topMisiones.length %}
          <ol class="metric-list">
            {% for jugador in analytics.topMisiones %}
              <li class="metric-item">
                <div class="metric-header">
                  <span class="metric-rank">#{{ loop.index }}</span>
                  <div>
                    <strong>{{ jugador.usuario }}</strong>
                    {% if jugador.nombre %}<br><small>{{ jugador.nombre }}</small>{% endif %}
                  </div>
                  <span class="metric-value">{{ jugador.misiones | formatNumber }} misiones</span>
                </div>
                <div class="metric-subtext">
                  <span>{{ jugador.clase }}</span>
                  {% if jugador.nivel %}<span>Nivel {{ jugador.nivel | formatNumber }}</span>{% endif %}
                  <span>{{ jugador.xp | formatNumber }} XP</span>
                </div>
              </li>
            {% endfor %}
          </ol>
        {% else %}
          <div class="empty-state">Todavía no se han registrado misiones.</div>
        {% endif %}
      </div>
    </div>
  </section>

  <section class="card">
    <h2>Rendimiento por clase</h2>
    {% if analytics.classBreakdown.length %}
      <ul class="progress-list">
        {% for clase in analytics.classBreakdown %}
          <li>
            <div class="progress-item-header">
              <span><strong>{{ clase.nombre }}</strong></span>
              <span>{{ clase.totalXp | formatNumber }} XP</span>
            </div>
            <div class="progress-bar">
              <span style="width: {{ clase.participacionXp | round(1) }}%"></span>
            </div>
            <div class="progress-footer">
              <span>{{ clase.participantes | formatNumber }} participantes</span>
              <span>XP promedio: {{ clase.xpPromedio | formatDecimal(1) }}</span>
              <span>Misiones promedio: {{ clase.misionesPromedio | formatDecimal(1) }}</span>
            </div>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <div class="empty-state">No hay clases registradas en el leaderboard.</div>
    {% endif %}
  </section>

  <section class="card">
    <h2>Distribución de rangos</h2>
    {% if analytics.rankDistribution.length %}
      <ul class="rank-chips">
        {% for rank in analytics.rankDistribution %}
          <li>
            <strong>{{ rank.nombre }}</strong>
            <span>{{ rank.participantes | formatNumber }}</span>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <div class="empty-state">Los rangos aparecerán cuando se registren participantes.</div>
    {% endif %}
  </section>

  <section class="card">
    <h2>Misiones más recientes</h2>
    {% if analytics.latestMissions.length %}
      <ol class="timeline">
        {% for item in analytics.latestMissions %}
          <li class="timeline-item">
            <div>
              <strong>{{ item.usuario }}</strong>
              {% if item.nombre %}<br><small>{{ item.nombre }}</small>{% endif %}
            </div>
            <div class="timeline-meta">
              <span>{{ item.clase }}</span>
              <span>{{ item.misiones | formatNumber }} misiones</span>
              <span>{{ item.xp | formatNumber }} XP</span>
              <time datetime="{{ item.ultimaMisionISO }}">{{ item.ultimaMisionLabel }}</time>
            </div>
          </li>
        {% endfor %}
      </ol>
    {% else %}
      <div class="empty-state">Cuando haya actividad reciente, la veremos aquí en forma de línea de tiempo.</div>
    {% endif %}
  </section>
{% endif %}

<section class="card">
  <h2>Actividad reciente</h2>
  {% if missionSummary.generatedAt %}
    <p><strong>mission-merge</strong> generó los artefactos el <time datetime="{{ missionSummary.generatedAt }}">{{ missionSummary.generatedAt }}</time>.</p>
  {% elseif missionSummary.missing %}
    <p class="empty-state">Todavía no se ha ejecutado <code>mission-merge</code> en este repositorio.</p>
  {% else %}
    <p>Resumen no disponible.</p>
  {% endif %}

  <dl>
    <div>
      <dt>Participantes procesados</dt>
      <dd>{{ missionSummary.participantesProcesados }}</dd>
    </div>
    <div>
      <dt>XP total acumulada</dt>
      <dd>{{ missionSummary.xpTotalAcumulada }}</dd>
    </div>
    <div>
      <dt>Misiones registradas</dt>
      <dd>{{ missionSummary.misionesRegistradas }}</dd>
    </div>
  </dl>
</section>

<section class="card">
  <h2>Leaderboard del gremio</h2>
  {% if leaderboard.jugadores.length %}
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th scope="col">Pos</th>
            <th scope="col">Usuario</th>
            <th scope="col">Clase</th>
            <th scope="col">Nivel</th>
            <th scope="col">Rango</th>
            <th scope="col">XP</th>
            <th scope="col">Misiones</th>
            <th scope="col">Última misión</th>
          </tr>
        </thead>
        <tbody>
          {% for jugador in leaderboard.jugadores %}
            <tr>
              <td>{{ jugador.posicion }}</td>
              <td>
                <strong>{{ jugador.usuario }}</strong>
                {% if jugador.nombre %}<br><small>{{ jugador.nombre }}</small>{% endif %}
              </td>
              <td>{{ jugador.clase | default("-") }}</td>
              <td>{{ jugador.nivel }}</td>
              <td>{{ jugador.rango | default("-") }}</td>
              <td>{{ jugador.xp }}</td>
              <td>{{ jugador.misiones }}</td>
              <td>
                {% if jugador.ultima_mision %}
                  <time datetime="{{ jugador.ultima_mision }}">{{ jugador.ultima_mision }}</time>
                {% else %}
                  —
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="empty-state">
      <p>Cuando se registren misiones y participantes, aparecerán aquí sus posiciones.</p>
    </div>
  {% endif %}
</section>
